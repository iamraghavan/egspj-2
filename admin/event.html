<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Event - EGSPJ</title>

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/bootstrap.css">

    <link rel="stylesheet" href="./vendors/iconly/bold.css">

    <link rel="stylesheet" href="./vendors/perfect-scrollbar/perfect-scrollbar.css">
    <link rel="stylesheet" href="./vendors/bootstrap-icons/bootstrap-icons.css">
    <link rel="stylesheet" href="./css/app.css">
    <link rel="shortcut icon" href="./images/favicon.svg" type="image/x-icon">
</head>


<style>
    @import url('https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap');

    .header-logo-text {
        font-family: 'Comic Neue', cursive;
        color: #FFF;
        font-size: 20px;
    }
</style>

<body>
    <div id="app">
        <div id="sidebar" class="active">
            <div class="sidebar-wrapper active">
                <div class="sidebar-header">
                    <div class="d-flex justify-content-between">
                        <div class="logo">
                            <h3 class="header-logo-text">
                                < Bumble Bees oAuth />
                            </h3>
                        </div>
                        <div class="toggler">
                            <a href="#" class="sidebar-hide d-xl-none d-block"><i class="bi bi-x bi-middle"></i></a>
                        </div>
                    </div>
                </div>


                <div class="sidebar-menu">
                    <ul class="menu">
                        <li class="sidebar-title">Menu</li>

                        <li class="sidebar-item  ">
                            <a href="./dashboard.html" class='sidebar-link'>
                                <i class="bi bi-folder-minus"></i>
                                <span>Dashboard</span>
                            </a>
                        </li>
                        <li class="sidebar-item  ">
                            <a href="./image.html" class='sidebar-link'>
                                <i class="bi bi-image-alt"></i>
                                <span>Upload Image</span>
                            </a>
                        </li>
                        <!-- <li class="sidebar-item  ">
                            <a href="./index.html" class='sidebar-link'>
                                <i class="bi bi-chat-quote-fill"></i>
                                <span>Chitram</span>
                            </a>
                        </li>
                        <li class="sidebar-item  ">
                            <a href="./index.html" class='sidebar-link'>
                                <i class="bi bi-option"></i>
                                <span>Family Tree</span>
                            </a>
                        </li> -->


                    </ul>
                </div>
                <button class="sidebar-toggler btn x"><i data-feather="x"></i></button>
            </div>
        </div>
        <div id="main" class='layout-navbar'>
            <header class='mb-3'>
                <nav class="navbar navbar-expand navbar-light ">
                    <div class="container-fluid">
                        <a href="#" class="burger-btn d-block">
                            <i class="bi bi-justify fs-3"></i>
                        </a>

                        <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                            data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

                                <li class="nav-item dropdown me-3">
                                    <a class="nav-link active dropdown-toggle" href="#" data-bs-toggle="dropdown"
                                        aria-expanded="false">
                                        <i class='bi bi-bell bi-sub fs-4 text-gray-600'></i>
                                    </a>
                                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                        <li>
                                            <h6 class="dropdown-header">Notifications</h6>
                                        </li>
                                        <li><a class="dropdown-item">No notification available</a></li>
                                    </ul>
                                </li>
                            </ul>
                            <div class="dropdown">
                                <a href="#" data-bs-toggle="dropdown" aria-expanded="false">
                                    <div class="user-menu d-flex">
                                        <div class="user-name text-end me-3">
                                            <h6 class="mb-0 text-gray-600">Administrator</h6>
                                            <p class="mb-0 text-sm text-gray-600"><span id="user" class="message">Hello,
                                                    <email-id></Email-id></span></p>
                                        </div>
                                        <div class="user-img d-flex align-items-center">
                                            <div class="avatar avatar-md">
                                                <img src="https://kurudhi.netlify.app/admin/images/man.png">
                                            </div>
                                        </div>
                                    </div>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownMenuButton">
                                    <li>
                                        <h6 class="dropdown-header">Hello, Admin!</h6>
                                    </li>

                                    <!-- <li class="sidebar-item  ">
                                        <a href="./index.html" class='sidebar-link'>
                                            <i class="bi bi-chat-quote-fill"></i>
                                            <span>Foreroom</span>
                                        </a>
                                    </li>
                                    <li class="sidebar-item  ">
                                        <a href="./index.html" class='sidebar-link'>
                                            <i class="bi bi-option"></i>
                                            <span>Family Tree</span>
                                        </a>
                                    </li> -->
                                    <!-- <li><a class="dropdown-item" href="#"><i class="icon-mid bi bi-person me-2"></i> My
                                            Profile</a></li> -->
                                    <!-- <li><a class="dropdown-item" href="#">
                                        <i class="icon-mid bi bi-chat-quote-fill me-2"></i>
                                        Foreroom
                                    </a>
                                </li> -->

                                    <!-- <li><a class="dropdown-item" href="#"><i class="icon-mid bi bi-gear me-2"></i>
                                            Settings</a></li> -->
                                    <!-- <li><a class="dropdown-item" href="#"><i class="icon-mid bi bi-wallet me-2"></i>
                                            Wallet</a></li>
                                    <li> -->
                                    <hr class="dropdown-divider">
                                    </li>
                                    <li onclick="logout()"><a class="dropdown-item" href="#"><i
                                                class="icon-mid bi bi-box-arrow-left me-2"></i> Logout</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </nav>
            </header>
            <div id="main-content">

                <div class="page-heading">
                    <div class="page-title">
                        <div class="row">
                            <div class="col-12 col-md-6 order-md-1 order-last">
                                <!-- <img width="200px" src="../assets/img/logo.png" alt="" srcset=""> -->

                            </div>

                            <div class="col-12 col-md-6 order-md-2 order-first">
                                <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                                    <ol class="breadcrumb">
                                        <li class="breadcrumb-item"><a href="index.html">Dashboard</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">Events
                                        </li>
                                    </ol>
                                </nav>
                            </div>
                        </div>
                    </div>
                    <section class="section">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title">Create Event | <span style="color: #000000;">
                                        < Bumble Bees oAuth />
                                    </span> </h4>
                            </div>




                            <div class="card-body">


                                <form class="form" action="" method="POST" id="createEventForm"
                                    enctype="multipart/form-data">
                                    <div class="row">
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="first-name-column">Title</label>
                                                <input type="text" inputmode="text" id="title" class="form-control"
                                                    placeholder="Title" name="title">
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="last-name-column">Description</label>
                                                <input inputmode="text" type="text" id="description"
                                                    class="form-control" placeholder="Description" name="description">
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="last-name-column">Place / Location</label>
                                                <input inputmode="text" value="EGSPJ SCHOOL" type="text" id="place"
                                                    class="form-control" placeholder="Place" name="place">
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="last-name-column">Date & Time</label>
                                                <input type="date" id="date" class="form-control" name="date">
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="last-name-column">Event Image</label>
                                                <input type="file" id="eventImage" class="form-control"
                                                    name="eventImage">
                                            </div>
                                        </div>
                                        <div class="col-12 d-flex justify-content-end">
                                            <button class="btn btn-primary me-1 mb-1" type="submit">Submit</button>
                                            <button type="reset"
                                                class="btn btn-light-secondary me-1 mb-1">Reset</button>
                                        </div>
                                    </div>
                                </form>


                            </div>
                        </div>


                    </section>
                    <!-- 
                    <table class="table table-striped" id="eventTable">
                      <thead>
                        <tr>
                          <th>Title</th>
                          <th>Description</th>
                          <th>Date</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                    </table> -->
                    <div class="container">
                        <table id="eventTable" class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Date</th>
                                    <th>Place</th>
                                    <th>Images</th>
                                    <th>Edit <i class="fas fa-edit"></i> </th>
                                    <th>Delete <i class="fas fa-trash"></i> </th>
                                </tr>
                            </thead>
                            <tbody id="eventList"></tbody>
                        </table>
                    </div>


                </div>
                <!--                 
        <button onclick="swalelement">submit</button>

        <script>

            swal("Here's the title!", "...and here's the text!");
        </script> -->

                <footer>
                    <div class="footer clearfix mb-0 text-muted">
                        <div class="float-start">
                            <p style="margin-left: 40px;"> <span id="current-year"></span> &copy;
                                < Bumble Bees oAuth />
                            </p>
                        </div>

                    </div>
                    <script>
                        // Get the current year
                        var currentYear = new Date().getFullYear();

                        // Set the current year in the HTML element with the specified ID
                        var currentYearElement = document.getElementById('current-year');
                        currentYearElement.textContent = currentYear.toString();

                    </script>

                </footer>
            </div>
        </div>
    </div>





    <script src="./vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
    <script src="./js/bootstrap.bundle.min.js"></script>
    <script src="./js/main.js"></script>


    <!-- A modal form to edit events -->
    <div id="editEventModal" class="modal">
        <div class="modal-dialog modal-dialog-centered modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Event</h5>
                    <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

            </div>
        </div>
    </div>

    <style>
        /* Style the background overlay for the modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0, 0, 0, 0.6);
            /* Dim background color */
        }

        /* Style the modal content */
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Style the modal header */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }

        /* Style the modal title */
        .modal-title {
            margin: 0;
            font-size: 18px;
        }

        /* Style the close button */
        .btn-close {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 24px;
            color: #000;
            opacity: 0.5;
        }

        .btn-close:hover {
            opacity: 1;
        }

        /* Style the modal footer */
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            padding: 10px;
            border-top: 1px solid #ccc;
        }
    </style>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.9.0/firebase-auth.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyC7EsiaYH-tJj-wNEQl8ZrrmdvKCWS7ztY",
            authDomain: "egspj-bumblebees.firebaseapp.com",
            databaseURL: "https://egspj-bumblebees-default-rtdb.firebaseio.com",
            projectId: "egspj-bumblebees",
            storageBucket: "egspj-bumblebees.appspot.com",
            messagingSenderId: "3531307553",
            appId: "1:3531307553:web:162f525f3ed82d7830c160",
            measurementId: "G-6W931XY0SQ"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        var auth = firebase.auth();
        const storage = firebase.storage();

        // Handle form submission
        $('#createEventForm').submit(function (e) {
            e.preventDefault();

            // Get form values
            const title = $('#title').val();
            const description = $('#description').val();
            const date = $('#date').val();
            const place = $('#place').val();
            const eventImage = $('#eventImage').prop('files')[0];

            if (eventImage) {
                // Upload event image to storage
                const storageRef = storage.ref('eventImages/' + eventImage.name);
                storageRef
                    .put(eventImage)
                    .then((snapshot) => {
                        return snapshot.ref.getDownloadURL();
                    })
                    .then((imageUrl) => {
                        // Save event details to Firebase with image URL
                        const eventRef = database.ref('events').push();
                        eventRef.set({
                            title: title,
                            description: description,
                            date: date,
                            place: place,
                            imageUrl: imageUrl
                        });
                    })
                    .catch((error) => {
                        console.error('Error uploading event image:', error);
                    });
            } else {
                // Save event details to Firebase with empty image URL
                const eventRef = database.ref('events').push();
                eventRef.set({
                    title: title,
                    description: description,
                    date: date,
                    place: place,
                    imageUrl: ''
                });
            }

            // Reset form
            $('#title').val('');
            $('#description').val('');
            $('#date').val('');
            $('#place').val('');
            $('#eventImage').val('');
        });

        // Retrieve events from Firebase and display in table
        const eventList = $('#eventList');
        database.ref('events').on('value', function (snapshot) {
            eventList.empty();

            snapshot.forEach(function (childSnapshot) {
                const event = childSnapshot.val();
                const eventRow = $('<tr>');

                eventRow.append($('<td>').text(event.title));
                eventRow.append($('<td>').text(event.description));
                eventRow.append($('<td>').text(event.date));
                eventRow.append($('<td>').text(event.place));
                eventRow.append($('<td>').html(event.imageUrl ? `<img src="${event.imageUrl}" alt="Event Image" width="100" height="100">` : ''));

                // Add edit button
                const editButton = $('<button>').text('Edit').html('<i class="fas fa-edit"></i> Edit').addClass('btn btn-outline-success');
                editButton.click(function () {
                    displayEditEventForm(childSnapshot.key);
                });
                eventRow.append($('<td>').append(editButton));

                // Add delete button
                const deleteButton = $('<button>').text('Delete').html('<i class="fas fa-trash"></i> Delete').addClass('btn btn-outline-danger');

                deleteButton.click(function () {
                    deleteEvent(childSnapshot.key);
                });
                eventRow.append($('<td>').append(deleteButton));

                eventList.append(eventRow);
            });
        });





        // Function to display event details in the modal form
        function displayEditEventForm(eventId) {
            database.ref('events/' + eventId).once('value').then(function (snapshot) {
                const event = snapshot.val();

                // Create a form for editing event details
                const editForm = `
      
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Edit Event</h5>
               <button class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form>
                <div class="mb-3">
                  <label for="editTitle" class="form-label">Title</label>
                  <input type="text" class="form-control" id="editTitle" value="${event.title}" required>
                </div>
                <div class="mb-3">
                  <label for="editDescription" class="form-label">Description</label>
                  <textarea class="form-control" id="editDescription" required>${event.description}</textarea>
                </div>
                <div class="mb-3">
                  <label for="editDate" class="form-label">Date</label>
                  <input type="date" class="form-control" id="editDate" value="${event.date ? event.date : ''}" required>
                </div>
                <div class="mb-3">
                  <label for="editPlace" class="form-label">Place</label>
                  <input type="text" class="form-control" id="editPlace" value="${event.place}" required>
                </div>
                <div class="mb-3">
                  <label for="editImage" class="form-label">Image</label>
                  <input type="file" class="form-control" id="editImage">
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" id=closeButton>Close</button>
              <button type="button" class="btn btn-primary" id="updateEventButton" data-event-id="${eventId}">Update</button>
            </div>
          </div>
 
    `;





                // Set the form content in the modal
                const modalContent = $('#editEventModal .modal-content');
                modalContent.html(editForm);

                // Open the modal
                $('#editEventModal').css('display', 'block');

                // Handle the "Update" button click
                $('#updateEventButton').on('click', function () {
                    // Get updated values from the form
                    const updatedTitle = $('#editTitle').val();
                    const updatedDescription = $('#editDescription').val();
                    const updatedDate = $('#editDate').val();
                    const updatedPlace = $('#editPlace').val();
                    const updatedImage = $('#editImage').prop('files')[0];

                    // Check for duplicate events before updating
                    isDuplicateEvent(updatedTitle).then((isDuplicate) => {
                        if (isDuplicate && updatedTitle !== event.title) {
                            alert('Event with the updated title already exists.');
                            return;
                        }

                        const eventData = {
                            title: updatedTitle,
                            description: updatedDescription,
                            date: updatedDate,
                            place: updatedPlace
                        };

                        if (updatedImage) {
                            // Upload updated event image to storage
                            const storageRef = storage.ref('eventImages/' + updatedImage.name);
                            storageRef
                                .put(updatedImage)
                                .then((snapshot) => {
                                    return snapshot.ref.getDownloadURL();
                                })
                                .then((imageUrl) => {
                                    eventData.imageUrl = imageUrl;
                                    // Update the event data in the database
                                    database.ref('events/' + eventId).update(eventData)
                                        .then(() => {
                                            // Close the modal after updating
                                            $('#editEventModal').css('display', 'none');
                                            // Refresh the table to reflect the changes
                                            displayEventsInTable();
                                        })
                                        .catch((error) => {
                                            console.error('Error updating event data:', error);
                                        });
                                })
                                .catch((error) => {
                                    console.error('Error uploading updated event image:', error);
                                });
                        } else {
                            // Update event data without changing the image
                            // Update the event data in the database
                            database.ref('events/' + eventId).update(eventData)
                                .then(() => {
                                    // Close the modal after updating
                                    $('#editEventModal').css('display', 'none');
                                    // Refresh the table to reflect the changes
                                    displayEventsInTable();
                                })
                                .catch((error) => {
                                    console.error('Error updating event data:', error);
                                });
                        }
                    });
                });
            });
        }

        // Function to close the modal form
        function closeModalForm() {
            const editEventModal = document.getElementById('editEventModal');
            if (editEventModal) {
                editEventModal.style.display = 'none';
            }
        }

        // Call the function when the "Close" button is clicked
        document.getElementById('closeButton').addEventListener('click', closeModalForm);




        // Function to check for duplicate events based on the title
        function isDuplicateEvent(title) {
            return new Promise((resolve, reject) => {
                // Retrieve events from the database
                database.ref('events').orderByChild('title').equalTo(title).once('value')
                    .then((snapshot) => {
                        const eventExists = snapshot.exists();
                        resolve(eventExists);
                    })
                    .catch((error) => {
                        reject(error);
                    });
            });
        }


        // Delete event
        function deleteEvent(eventId) {
            database.ref('events/' + eventId).remove();
        }



        // Delete event
        function deleteEvent(eventId) {
            database.ref('events/' + eventId).remove();
        }

        // Retrieve events from Firebase and display in <h1> and <p> tags
        const eventDisplay = $('#eventDisplay');
        database.ref('events').on('value', function (snapshot) {
            eventDisplay.empty();

            snapshot.forEach(function (childSnapshot) {
                const event = childSnapshot.val();

                // Create <h1> and <p> elements for title and description
                const eventTitle = $('<h1>').text(event.title);
                const eventDescription = $('<p>').text(event.description);
                const eventDate = $('<p>').text(event.date);
                const eventPlace = $('<p>').text(event.place);
                const eventImage = $('<img>').attr('src', event.imageUrl).attr('alt', 'Event Image').attr('width', '100').attr('height', '100');

                // Append elements to the event display container
                eventDisplay.append(eventTitle, eventDescription, eventPlace, eventDate, eventImage);
            });
        });





        firebase.auth().onAuthStateChanged((user) => {
            if (!user) {
                location.replace("../index")
            } else {
                document.getElementById("user").innerHTML = "Hello, " + user.email
            }

        })


        function logout() {
            firebase.auth().signOut()
        }


    </script>






</body>


</html>